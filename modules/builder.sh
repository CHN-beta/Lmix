source $stdenv/setup

shopt -s nullglob

modfile="$out/modules/$modName"
mkdir -p `dirname "$modfile"`

cat > $modfile << EOF
-- $modName
-- autogenerated by nix-with-modules

local pkgName = myModuleName()
local version = myModuleVersion()

EOF

addPaths () {
  # PATH
  if [[ -d $1/bin ]] ; then
    echo -e "prepend_path(\"PATH\", \"$1/bin\")" >> $modfile
  fi
  # MANPATH
  if [[ -d $1/share/man ]] ; then
    echo -e "prepend_path(\"MANPATH\", \"$1/share/man\")" >> $modfile
  fi
  # PKG_CONFIG_PATH
  if [[ -d $1/lib/pkgconfig ]] ; then
    echo -e "prepend_path(\"PKG_CONFIG_PATH\", \"$1/lib/pkgconfig\")" >> $modfile
  fi
  if [[ -d $1/share/pkgconfig ]] ; then
    echo -e "prepend_path(\"PKG_CONFIG_PATH\", \"$1/share/pkgconfig\")" >> $modfile
  fi
  # CMAKE_SYSTEM_PREFIX_PATH
  if [[ -f $1/lib/cmake ]] ; then
    echo -e "prepend_path(\"CMAKE_SYSTEM_PREFIX_PATH\", \"$1/lib/cmake\")" >> $modfile
  fi
  # PERL5LIB
  if [[ -d $1/lib/perl5/site_perl ]] ; then
    echo -e "prepend_path(\"PERL5LIB\", \"$1/lib/perl5/site_perl\")" >> $modfile
  fi
  # LD_LIBRARY_PATH
  libs=($1/lib/lib*.so)
  if [[ $addLDLibPath && -n $libs ]] ; then
    echo -e "prepend_path(\"LD_LIBRARY_PATH\", \"$1/lib\")" >> $modfile
  fi
}

addPkgVariables () {
  # PAC_BASE - base nix store path
  echo -e "setenv(\"${pacName}_BASE\", \"${PAC_BASE}\")" >> $modfile
  # PAC_LIBDIR - library directory
  if [[ -n "$PAC_LIBDIR" ]] ; then
    echo -e "setenv(\"${pacName}_LIBDIR\", \"${PAC_LIBDIR}\")" >> $modfile
    # PAC_LIB - setting for static linking
    if [[ -n "$PAC_LIB" ]] ; then
      echo -e "setenv(\"${pacName}_LIB\", \"${PAC_LIB}\")" >> $modfile
    fi
    # PAC_SHLIB - setting for dynamic linking
    if [[ -n "$PAC_SHLIB" ]] ; then
      echo -e "setenv(\"${pacName}_SHLIB\", \"${PAC_SHLIB}\")" >> $modfile
    fi
  fi
  # PAC_INC - include directory
  if [[ -n "$PAC_INC" ]] ; then
    echo -e "setenv(\"${pacName}_INC\", \"${PAC_INC}\")" >> $modfile
  fi
  # extra variables e.g. PAC_DOC, PAC_MPI_LIB, PAC_WWW don't have default value
  for vv in $extraPkgVariables ; do
    echo -e "setenv(\"${vv%%=*}\", \"vv#*=\")" >> $modfile
  done

}

for i in $buildInputs;
do
  addPaths $i
done

echo >> $modfile

addPkgVariables

echo >> $modfile

for vv in $extraEnvVariables ; do
  echo -e "setenv(\"${vv%%=*}\", \"vv#*=\")" >> $modfile
done
